<!DOCTYPE html>
<html>
  <head>
    <title>Full Page Blink Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: black;
        font-family: Arial, sans-serif;
      }

      .container {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      video,
      canvas {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #status {
        position: absolute;
        top: 10px;
        left: 0;
        right: 0;
        text-align: center;
        padding: 10px;
        font-size: 24px;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        z-index: 10;
      }

      #alert {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 0, 0, 0.3);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 5;
      }

      #alert-text {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 10px;
        font-size: 30px;
        font-weight: bold;
      }

      #debug {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px;
        font-size: 14px;
        border-radius: 5px;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="output"></canvas>
      <div id="status">Loading camera...</div>
      <div id="alert"><div id="alert-text">EYES CLOSED TOO LONG!</div></div>
      <div id="debug">EAR: 0.00 | State: Monitoring</div>
    </div>

    <audio id="alertSound" src="alert.mp3"></audio>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("output");
      const ctx = canvas.getContext("2d");
      const status = document.getElementById("status");
      const alertBox = document.getElementById("alert");
      const alertSound = document.getElementById("alertSound");
      const debug = document.getElementById("debug");

      const EAR_THRESHOLD = 0.23;
      const CLOSED_THRESHOLD = 10;
      const WINDOW_SIZE = 24;

      let blinkWindow = [];
      let consecutiveClosedFrames = 0;
      let isAlertActive = false;

      const appInventorBridge = {
        sendAlert: function (isActive) {
          if (window.AppInventor && window.AppInventor.setWebViewString) {
            window.AppInventor.setWebViewString(
              "ALERT_STATE=" + (isActive ? "ACTIVE" : "INACTIVE")
            );
          }
        },
      };

      function getEAR(landmarks, indices) {
        const p1 = landmarks[indices[1]];
        const p2 = landmarks[indices[2]];
        const p3 = landmarks[indices[5]];
        const p4 = landmarks[indices[4]];
        const p0 = landmarks[indices[0]];
        const p5 = landmarks[indices[3]];

        const vertical1 = Math.hypot(p2.x - p4.x, p2.y - p4.y);
        const vertical2 = Math.hypot(p1.x - p3.x, p1.y - p3.y);
        const horizontal = Math.hypot(p0.x - p5.x, p0.y - p5.y);

        return (vertical1 + vertical2) / (2.0 * horizontal);
      }

      function resizeCanvas() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }

      function onResults(results) {
        if (video.videoWidth && video.videoHeight) {
          resizeCanvas();
        }

        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

        if (results.multiFaceLandmarks.length > 0) {
          const landmarks = results.multiFaceLandmarks[0];
          drawConnectors(ctx, landmarks, FACEMESH_TESSELATION, {
            color: "#C0C0C070",
            lineWidth: 1,
          });
          drawConnectors(ctx, landmarks, FACEMESH_LEFT_EYE, {
            color: "#30FF30",
            lineWidth: 2,
          });
          drawConnectors(ctx, landmarks, FACEMESH_RIGHT_EYE, {
            color: "#30FF30",
            lineWidth: 2,
          });

          const leftEAR = getEAR(landmarks, [33, 160, 158, 133, 153, 144]);
          const rightEAR = getEAR(landmarks, [362, 385, 387, 263, 373, 380]);
          const avgEAR = (leftEAR + rightEAR) / 2;

          debug.textContent = `EAR: ${avgEAR.toFixed(2)} | State: ${
            consecutiveClosedFrames > 0 ? "Eyes Closed" : "Monitoring"
          }`;

          const bothClosed =
            leftEAR < EAR_THRESHOLD && rightEAR < EAR_THRESHOLD;
          blinkWindow.push(bothClosed ? 1 : 0);
          if (blinkWindow.length > WINDOW_SIZE) blinkWindow.shift();
          consecutiveClosedFrames = bothClosed
            ? consecutiveClosedFrames + 1
            : 0;

          if (
            blinkWindow.length === WINDOW_SIZE &&
            consecutiveClosedFrames >= CLOSED_THRESHOLD
          ) {
            if (!isAlertActive) {
              isAlertActive = true;
              status.textContent = "ALERT: Eyes closed too long!";
              alertBox.style.display = "flex";
              alertSound.loop = true;
              alertSound.play();
              appInventorBridge.sendAlert(true);
            }
          } else {
            if (isAlertActive) {
              isAlertActive = false;
              status.textContent = "Monitoring...";
              alertBox.style.display = "none";
              alertSound.pause();
              alertSound.currentTime = 0;
              appInventorBridge.sendAlert(false);
            }
          }
        } else {
          status.textContent = "No face detected";
          debug.textContent = "EAR: N/A | State: No Face";
        }

        ctx.restore();
      }

      const faceMesh = new FaceMesh({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
      });

      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      faceMesh.onResults(onResults);

      const camera = new Camera(video, {
        onFrame: async () => {
          await faceMesh.send({ image: video });
        },
        width: 1280,
        height: 720,
      });

      camera.start().then(() => {
        status.textContent = "Monitoring...";
      });

      window.addEventListener("message", function (event) {
        if (event.data && event.data.action === "getAlertStatus") {
          appInventorBridge.sendAlert(isAlertActive);
        }
      });
    </script>
  </body>
</html>
